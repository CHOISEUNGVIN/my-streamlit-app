import json
import requests
import streamlit as st
from typing import Dict, List, Tuple, Optional

# OpenAI Python SDK (v2+)
from openai import OpenAI

# -----------------------------
# Page config
# -----------------------------
st.set_page_config(page_title="🎬 나와 어울리는 영화는?", page_icon="🎬", layout="wide")

st.title("🎬 나와 어울리는 영화는?")
st.write("질문에 답하면, 당신의 성향을 분석해 **어울리는 영화 장르**와 **지금 인기 있는 영화 5편**을 추천해드려요! 🎥🍿")
st.caption("※ OpenAI는 '분석/추천 이유 생성'에 사용되고, 영화 데이터는 TMDB에서 가져옵니다.")
st.divider()

# -----------------------------
# Sidebar: API keys
# -----------------------------
st.sidebar.header("🔑 API 설정")
openai_key = st.sidebar.text_input("OpenAI API Key", type="password", placeholder="OpenAI API Key")
tmdb_key = st.sidebar.text_input("TMDB API Key", type="password", placeholder="TMDB API Key")
model_name = st.sidebar.text_input("OpenAI 모델(선택)", value="gpt-5.2-mini")
st.sidebar.caption("모델명은 계정/권한에 따라 다를 수 있어요.")

# -----------------------------
# TMDB config
# -----------------------------
POSTER_BASE = "https://image.tmdb.org/t/p/w500"

# 요구사항 장르 ID
TMDB_GENRES = {
    "액션": 28,
    "코미디": 35,
    "드라마": 18,
    "SF": 878,
    "로맨스": 10749,
    "판타지": 14,
}

# 4지선다(성향 그룹) -> 장르 후보(더 정교한 혼합을 위해 2개 후보를 둠)
PREFERENCE_TO_GENRES = {
    "로맨스/드라마": ["로맨스", "드라마"],
    "액션/어드벤처": ["액션"],  # 요구사항 내 ID 기준으로 액션만 사용
    "SF/판타지": ["SF", "판타지"],
    "코미디": ["코미디"],
}

# -----------------------------
# Questions (10)
# option format: "<TAG> | <TEXT>"
# TAG: 로맨스/드라마, 액션/어드벤처, SF/판타지, 코미디
# -----------------------------
questions = [
    {
        "q": "Q1. 시험이 끝난 금요일 밤, 너의 선택은?",
        "options": [
            "로맨스/드라마 | 조용한 방에서 여운 남는 영화 한 편 보며 생각에 잠긴다",
            "액션/어드벤처 | 친구들이랑 극장 가서 박진감 넘치는 영화로 스트레스 날린다",
            "SF/판타지 | 세계관 탄탄한 영화 보면서 “이 설정 뭐야” 하며 몰입한다",
            "코미디 | 아무 생각 안 하고 웃긴 영화 틀어놓고 깔깔 웃는다",
        ],
    },
    {
        "q": "Q2. 영화 속 주인공으로 살 하루가 주어진다면?",
        "options": [
            "로맨스/드라마 | 사랑과 인생의 갈림길에서 고민하는 주인공",
            "액션/어드벤처 | 위기의 순간마다 몸으로 돌파하는 히어로",
            "SF/판타지 | 다른 차원이나 미래 세계를 여행하는 존재",
            "코미디 | 사고를 치지만 미워할 수 없는 문제적 인물",
        ],
    },
    {
        "q": "Q3. 영화를 보고 난 뒤, 네가 가장 중요하게 느끼는 건?",
        "options": [
            "로맨스/드라마 | 감정선과 메시지, 그리고 여운",
            "액션/어드벤처 | 액션 장면의 쾌감과 긴장감",
            "SF/판타지 | 설정의 신선함과 “와 이런 생각을?” 하는 놀라움",
            "코미디 | 얼마나 웃었는지, 기분이 가벼워졌는지",
        ],
    },
    {
        "q": "Q4. 비 오는 날, 약속이 취소됐다. 어떤 영화가 땡겨?",
        "options": [
            "로맨스/드라마 | 혼자 보기 좋은 감성적인 영화",
            "액션/어드벤처 | 집에서라도 스케일 큰 영화로 기분 전환",
            "SF/판타지 | 현실을 잠시 잊게 해주는 다른 세계 이야기",
            "코미디 | 우울함을 날려줄 웃긴 영화",
        ],
    },
    {
        "q": "Q5. 친구가 “이 영화 꼭 봐야 해”라고 추천했다. 이유는?",
        "options": [
            "로맨스/드라마 | “인생에 대해 생각하게 돼”",
            "액션/어드벤처 | “액션 미쳤어, 시간 순삭”",
            "SF/판타지 | “세계관이랑 설정이 진짜 신박해”",
            "코미디 | “진짜 웃다가 눈물 난다”",
        ],
    },
    # 추가 질문 5개
    {
        "q": "Q6. 영화 예고편을 볼 때 제일 먼저 꽂히는 건?",
        "options": [
            "로맨스/드라마 | 표정/대사/감정선이 확 끌
